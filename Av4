-- Heavens Ultimate Hub
-- FPS Optimizer + ESP + Aimbot
-- UI by EmmanuelFushiguro (Fluent Plus)

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = Workspace.CurrentCamera

local player = Players.LocalPlayer
local mouse = player:GetMouse()

-- Load Fluent UI Library (FIXED)
local Fluent, SaveManager, InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/discoart/FluentPlus/refs/heads/main/Beta.lua"))()

-- Create Window
local Window = Fluent:CreateWindow({
    Title = "‚ö° Heavens Ultimate Hub",
    SubTitle = "by EmmanuelFushiguro",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.LeftControl
})

-- Create Tabs
local Tabs = {
    FPS = Window:AddTab({ Title = "‚ö° FPS Optimizer", Icon = "zap" }),
    Combat = Window:AddTab({ Title = "‚öîÔ∏è Combat", Icon = "crosshair" }),
    Visuals = Window:AddTab({ Title = "üëÅÔ∏è Visuals", Icon = "eye" }),
    Settings = Window:AddTab({ Title = "‚öôÔ∏è Settings", Icon = "settings" })
}

-- Settings Storage
local settings = {
    -- FPS
    autoCleanDebris = false,
    lowGraphics = false,
    
    -- Combat
    aimbotEnabled = false,
    aimbotFOV = 200,
    aimbotSmoothing = 0.1,
    aimbotPart = "Head",
    silentAim = true,
    
    -- ESP
    espEnabled = false,
    espBoxes = true,
    espNames = true,
    espDistance = true,
    espHealth = true,
    espTracers = false,
    espMaxDistance = 1000
}

-- ============================================
-- FPS OPTIMIZER TAB
-- ============================================

Tabs.FPS:AddParagraph({
    Title = "FPS Optimization",
    Content = "Tools to boost your FPS without lag spikes"
})

-- Server Refresh
Tabs.FPS:AddButton({
    Title = "üîÑ Server Refresh",
    Description = "Clean invisible objects (no lag spike)",
    Callback = function()
        task.spawn(function()
            local cleaned = 0
            
            -- Only clean truly invisible/destroyed parts
            for _, obj in pairs(Workspace:GetDescendants()) do
                local isPlayerPart = false
                for _, p in pairs(Players:GetPlayers()) do
                    if p.Character and obj:IsDescendantOf(p.Character) then
                        isPlayerPart = true
                        break
                    end
                end
                
                if not isPlayerPart and obj:IsA("BasePart") then
                    if obj.Transparency >= 1 or obj.Size.Magnitude < 0.05 then
                        pcall(function() obj:Destroy() end)
                        cleaned = cleaned + 1
                    end
                end
            end
            
            collectgarbage("collect")
            
            Fluent:Notify({
                Title = "Server Refreshed",
                Content = "Cleaned " .. cleaned .. " objects!",
                Duration = 3
            })
        end)
    end
})

-- Clean Debris (Optimized - no lag)
Tabs.FPS:AddButton({
    Title = "üßπ Clean Debris",
    Description = "Remove destruction debris (optimized)",
    Callback = function()
        task.spawn(function()
            local cleaned = 0
            local batchSize = 50
            local batch = {}
            
            for _, obj in pairs(Workspace:GetDescendants()) do
                local isPlayerPart = false
                for _, p in pairs(Players:GetPlayers()) do
                    if p.Character and obj:IsDescendantOf(p.Character) then
                        isPlayerPart = true
                        break
                    end
                end
                
                if not isPlayerPart and obj:IsA("BasePart") then
                    local name = obj.Name:lower()
                    if name:find("debris") or name:find("rubble") or name:find("crater") then
                        table.insert(batch, obj)
                        cleaned = cleaned + 1
                        
                        -- Process in batches to avoid lag
                        if #batch >= batchSize then
                            for _, part in ipairs(batch) do
                                pcall(function() part:Destroy() end)
                            end
                            batch = {}
                            task.wait()
                        end
                    end
                end
            end
            
            -- Clean remaining batch
            for _, part in ipairs(batch) do
                pcall(function() part:Destroy() end)
            end
            
            Fluent:Notify({
                Title = "Debris Cleaned",
                Content = "Removed " .. cleaned .. " objects!",
                Duration = 3
            })
        end)
    end
})

-- Low Graphics Toggle
Tabs.FPS:AddToggle("LowGraphics", {
    Title = "üìâ Low Graphics Mode",
    Default = false,
    Callback = function(value)
        settings.lowGraphics = value
        
        pcall(function()
            for _, effect in pairs(Lighting:GetChildren()) do
                if effect:IsA("PostEffect") then
                    effect.Enabled = not value
                end
            end
            
            Lighting.GlobalShadows = not value
        end)
    end
})

-- Auto Clean Debris
Tabs.FPS:AddToggle("AutoClean", {
    Title = "üîÅ Auto-Clean Debris",
    Default = false,
    Callback = function(value)
        settings.autoCleanDebris = value
    end
})

-- ============================================
-- COMBAT TAB (AIMBOT)
-- ============================================

Tabs.Combat:AddParagraph({
    Title = "Undetectable Aimbot",
    Content = "Silent aim with smoothing - hard to detect"
})

-- Aimbot Toggle
Tabs.Combat:AddToggle("Aimbot", {
    Title = "üéØ Enable Aimbot",
    Default = false,
    Callback = function(value)
        settings.aimbotEnabled = value
        
        if value then
            Fluent:Notify({
                Title = "Aimbot Enabled",
                Content = "Silent aim active!",
                Duration = 2
            })
        end
    end
})

-- FOV Slider
Tabs.Combat:AddSlider("AimbotFOV", {
    Title = "üî≠ Aimbot FOV",
    Description = "Field of view radius",
    Default = 200,
    Min = 50,
    Max = 500,
    Rounding = 0,
    Callback = function(value)
        settings.aimbotFOV = value
    end
})

-- Smoothing Slider
Tabs.Combat:AddSlider("AimbotSmooth", {
    Title = "üåä Smoothness",
    Description = "Lower = more human-like",
    Default = 0.1,
    Min = 0.05,
    Max = 1,
    Rounding = 2,
    Callback = function(value)
        settings.aimbotSmoothing = value
    end
})

-- Target Part Dropdown
Tabs.Combat:AddDropdown("AimbotPart", {
    Title = "üéØ Target Part",
    Values = {"Head", "HumanoidRootPart", "UpperTorso", "LowerTorso"},
    Default = 1,
    Callback = function(value)
        settings.aimbotPart = value
    end
})

-- Silent Aim Toggle
Tabs.Combat:AddToggle("SilentAim", {
    Title = "ü§´ Silent Aim",
    Description = "No camera movement (undetectable)",
    Default = true,
    Callback = function(value)
        settings.silentAim = value
    end
})

-- ============================================
-- VISUALS TAB (ESP)
-- ============================================

Tabs.Visuals:AddParagraph({
    Title = "ESP System",
    Content = "See players through walls"
})

-- ESP Toggle
Tabs.Visuals:AddToggle("ESP", {
    Title = "üëÅÔ∏è Enable ESP",
    Default = false,
    Callback = function(value)
        settings.espEnabled = value
        
        if not value then
            -- Clean up all ESP
            for _, v in pairs(Camera:GetChildren()) do
                if v.Name == "ESP_Holder" then
                    v:Destroy()
                end
            end
        end
    end
})

-- ESP Features
Tabs.Visuals:AddToggle("ESPBoxes", {
    Title = "üì¶ Boxes",
    Default = true,
    Callback = function(value)
        settings.espBoxes = value
    end
})

Tabs.Visuals:AddToggle("ESPNames", {
    Title = "üìù Names",
    Default = true,
    Callback = function(value)
        settings.espNames = value
    end
})

Tabs.Visuals:AddToggle("ESPDistance", {
    Title = "üìè Distance",
    Default = true,
    Callback = function(value)
        settings.espDistance = value
    end
})

Tabs.Visuals:AddToggle("ESPHealth", {
    Title = "‚ù§Ô∏è Health Bar",
    Default = true,
    Callback = function(value)
        settings.espHealth = value
    end
})

Tabs.Visuals:AddToggle("ESPTracers", {
    Title = "‚û°Ô∏è Tracers",
    Default = false,
    Callback = function(value)
        settings.espTracers = value
    end
})

-- ESP Distance Slider
Tabs.Visuals:AddSlider("ESPDistance", {
    Title = "üì° Max ESP Distance",
    Default = 1000,
    Min = 100,
    Max = 5000,
    Rounding = 0,
    Callback = function(value)
        settings.espMaxDistance = value
    end
})

-- ============================================
-- SETTINGS TAB
-- ============================================

Tabs.Settings:AddParagraph({
    Title = "About",
    Content = "Heavens Ultimate Hub - FPS Optimizer, ESP & Aimbot\nUI by EmmanuelFushiguro (Godly Hub)"
})

-- ============================================
-- AIMBOT SYSTEM
-- ============================================

local function getClosestPlayer()
    local closestPlayer = nil
    local shortestDistance = settings.aimbotFOV
    
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= player and p.Character then
            local targetPart = p.Character:FindFirstChild(settings.aimbotPart)
            
            if targetPart then
                local screenPos, onScreen = Camera:WorldToViewportPoint(targetPart.Position)
                
                if onScreen then
                    local mousePos = Vector2.new(mouse.X, mouse.Y)
                    local targetPos = Vector2.new(screenPos.X, screenPos.Y)
                    local distance = (mousePos - targetPos).Magnitude
                    
                    if distance < shortestDistance then
                        shortestDistance = distance
                        closestPlayer = p
                    end
                end
            end
        end
    end
    
    return closestPlayer
end

-- Aimbot Loop (FIXED - Added safety checks)
RunService.RenderStepped:Connect(function()
    if not settings.aimbotEnabled then return end
    if not player.Character then return end
    
    local target = getClosestPlayer()
    
    if target and target.Character then
        local targetPart = target.Character:FindFirstChild(settings.aimbotPart)
        
        if targetPart then
            local targetHum = target.Character:FindFirstChildOfClass("Humanoid")
            
            -- Check if target is alive
            if targetHum and targetHum.Health > 0 then
                if settings.silentAim then
                    -- Silent aim (no camera movement)
                    local screenPos, onScreen = Camera:WorldToViewportPoint(targetPart.Position)
                    
                    if onScreen then
                        local targetPos = targetPart.Position
                        local currentCam = Camera.CFrame
                        local targetCam = CFrame.new(currentCam.Position, targetPos)
                        
                        Camera.CFrame = currentCam:Lerp(targetCam, settings.aimbotSmoothing)
                    end
                else
                    -- Smooth aim (visible)
                    local targetPos = targetPart.Position
                    local currentCam = Camera.CFrame
                    local targetCam = CFrame.new(currentCam.Position, targetPos)
                    
                    Camera.CFrame = currentCam:Lerp(targetCam, settings.aimbotSmoothing)
                end
            end
        end
    end
end)

-- ============================================
-- ESP SYSTEM
-- ============================================

local espObjects = {}

local function createESP(plr)
    if plr == player then return end
    
    local holder = Instance.new("Folder")
    holder.Name = "ESP_Holder"
    holder.Parent = Camera
    
    -- Box
    local box = Drawing.new("Square")
    box.Visible = false
    box.Color = Color3.fromRGB(255, 255, 255)
    box.Thickness = 2
    box.Transparency = 1
    box.Filled = false
    
    -- Name
    local name = Drawing.new("Text")
    name.Visible = false
    name.Color = Color3.fromRGB(255, 255, 255)
    name.Size = 16
    name.Center = true
    name.Outline = true
    name.Font = 2
    name.Text = plr.Name
    
    -- Distance
    local distance = Drawing.new("Text")
    distance.Visible = false
    distance.Color = Color3.fromRGB(255, 255, 255)
    distance.Size = 14
    distance.Center = true
    distance.Outline = true
    distance.Font = 2
    
    -- Health Bar
    local healthBar = Drawing.new("Square")
    healthBar.Visible = false
    healthBar.Color = Color3.fromRGB(0, 255, 0)
    healthBar.Thickness = 1
    healthBar.Transparency = 1
    healthBar.Filled = true
    
    -- Tracer
    local tracer = Drawing.new("Line")
    tracer.Visible = false
    tracer.Color = Color3.fromRGB(255, 255, 255)
    tracer.Thickness = 1
    tracer.Transparency = 1
    
    espObjects[plr] = {
        box = box,
        name = name,
        distance = distance,
        healthBar = healthBar,
        tracer = tracer,
        holder = holder
    }
end

local function updateESP()
    if not settings.espEnabled then return end
    
    for plr, esp in pairs(espObjects) do
        pcall(function()
            if plr and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
                local hrp = plr.Character.HumanoidRootPart
                local humanoid = plr.Character:FindFirstChildOfClass("Humanoid")
                
                -- Check if humanoid exists and is alive
                if not humanoid or humanoid.Health <= 0 then
                    esp.box.Visible = false
                    esp.name.Visible = false
                    esp.distance.Visible = false
                    esp.healthBar.Visible = false
                    esp.tracer.Visible = false
                    return
                end
                
                local dist = (hrp.Position - Camera.CFrame.Position).Magnitude
                
                if dist <= settings.espMaxDistance then
                    local screenPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                    
                    if onScreen and screenPos.Z > 0 then
                        -- Calculate box size
                        local head = plr.Character:FindFirstChild("Head")
                        if head then
                            local topPos = Camera:WorldToViewportPoint((hrp.CFrame * CFrame.new(0, 3, 0)).Position)
                            local bottomPos = Camera:WorldToViewportPoint((hrp.CFrame * CFrame.new(0, -3, 0)).Position)
                            
                            local height = math.abs(topPos.Y - bottomPos.Y)
                            local width = height / 2
                            
                            -- Box
                            if settings.espBoxes then
                                esp.box.Visible = true
                                esp.box.Size = Vector2.new(width, height)
                                esp.box.Position = Vector2.new(screenPos.X - width / 2, topPos.Y)
                            else
                                esp.box.Visible = false
                            end
                            
                            -- Name
                            if settings.espNames then
                                esp.name.Visible = true
                                esp.name.Position = Vector2.new(screenPos.X, topPos.Y - 20)
                            else
                                esp.name.Visible = false
                            end
                            
                            -- Distance
                            if settings.espDistance then
                                esp.distance.Visible = true
                                esp.distance.Text = math.floor(dist) .. "m"
                                esp.distance.Position = Vector2.new(screenPos.X, bottomPos.Y + 5)
                            else
                                esp.distance.Visible = false
                            end
                            
                            -- Health Bar
                            if settings.espHealth and humanoid then
                                esp.healthBar.Visible = true
                                local healthPercent = humanoid.Health / humanoid.MaxHealth
                                esp.healthBar.Size = Vector2.new(3, height * healthPercent)
                                esp.healthBar.Position = Vector2.new(screenPos.X - width / 2 - 8, topPos.Y + (height * (1 - healthPercent)))
                                esp.healthBar.Color = Color3.fromRGB(255 * (1 - healthPercent), 255 * healthPercent, 0)
                            else
                                esp.healthBar.Visible = false
                            end
                            
                            -- Tracer
                            if settings.espTracers then
                                esp.tracer.Visible = true
                                esp.tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y)
                                esp.tracer.To = Vector2.new(screenPos.X, screenPos.Y)
                            else
                                esp.tracer.Visible = false
                            end
                        end
                    else
                        -- Not on screen
                        esp.box.Visible = false
                        esp.name.Visible = false
                        esp.distance.Visible = false
                        esp.healthBar.Visible = false
                        esp.tracer.Visible = false
                    end
                else
                    -- Too far
                    esp.box.Visible = false
                    esp.name.Visible = false
                    esp.distance.Visible = false
                    esp.healthBar.Visible = false
                    esp.tracer.Visible = false
                end
            else
                -- Dead or removed
                esp.box.Visible = false
                esp.name.Visible = false
                esp.distance.Visible = false
                esp.healthBar.Visible = false
                esp.tracer.Visible = false
            end
        end)
    end
end

-- Create ESP for existing players
for _, plr in pairs(Players:GetPlayers()) do
    createESP(plr)
end

-- Create ESP for new players
Players.PlayerAdded:Connect(function(plr)
    createESP(plr)
end)

-- Remove ESP for leaving players
Players.PlayerRemoving:Connect(function(plr)
    if espObjects[plr] then
        espObjects[plr].box:Remove()
        espObjects[plr].name:Remove()
        espObjects[plr].distance:Remove()
        espObjects[plr].healthBar:Remove()
        espObjects[plr].tracer:Remove()
        espObjects[plr].holder:Destroy()
        espObjects[plr] = nil
    end
end)

-- ESP Update Loop (FIXED - Better error handling)
RunService.RenderStepped:Connect(function()
    if not settings.espEnabled then 
        -- Hide all ESP when disabled
        for _, esp in pairs(espObjects) do
            pcall(function()
                esp.box.Visible = false
                esp.name.Visible = false
                esp.distance.Visible = false
                esp.healthBar.Visible = false
                esp.tracer.Visible = false
            end)
        end
        return 
    end
    
    pcall(function()
        updateESP()
    end)
end)

-- ============================================
-- AUTO-CLEAN DEBRIS LOOP
-- ============================================

task.spawn(function()
    while task.wait(20) do
        if settings.autoCleanDebris then
            local batch = {}
            for _, obj in pairs(Workspace:GetDescendants()) do
                local isPlayerPart = false
                for _, p in pairs(Players:GetPlayers()) do
                    if p.Character and obj:IsDescendantOf(p.Character) then
                        isPlayerPart = true
                        break
                    end
                end
                
                if not isPlayerPart and obj:IsA("BasePart") then
                    local name = obj.Name:lower()
                    if name:find("debris") or name:find("rubble") then
                        table.insert(batch, obj)
                        
                        if #batch >= 30 then
                            for _, part in ipairs(batch) do
                                pcall(function() part:Destroy() end)
                            end
                            batch = {}
                            task.wait()
                        end
                    end
                end
            end
        end
    end
end)

-- Initialization
Fluent:Notify({
    Title = "‚ö° Heavens Ultimate Hub",
    Content = "Loaded! FPS Optimizer + ESP + Aimbot ready!",
    Duration = 5
})

print("=================================")
print("‚ö° Heavens Ultimate Hub Loaded")
print("UI by EmmanuelFushiguro (Godly Hub)")
print("‚úÖ FPS Optimizer | ESP | Aimbot")
print("=================================")
