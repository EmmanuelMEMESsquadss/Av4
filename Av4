-- LocalScript (StarterPlayerScripts)
-- Multi-Universal Aim Assist [FIXED VERSION]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Teams = game:GetService("Teams")

-- Only run on mobile
if not UserInputService.TouchEnabled then
    return
end

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local character, humanoid, hrp

local aimAssistEnabled = false
local currentTarget = nil
local MAX_DISTANCE = 300
local FOV_RADIUS = 150

-- Wait for character to load properly
local function setupCharacter(char)
    character = char
    humanoid = char:WaitForChild("Humanoid", 5)
    hrp = char:WaitForChild("HumanoidRootPart", 5)
end

if player.Character then 
    setupCharacter(player.Character) 
end
player.CharacterAdded:Connect(setupCharacter)

-- GUI Setup (keeping your existing GUI code)
local gui = Instance.new("ScreenGui")
gui.Name = "AimAssistUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local miniBtn = Instance.new("TextButton")
miniBtn.Size = UDim2.new(0, 50, 0, 50)
miniBtn.Position = UDim2.new(0.85, -50, 0.3, 0)
miniBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
miniBtn.BorderSizePixel = 0
miniBtn.Font = Enum.Font.GothamBold
miniBtn.TextSize = 20
miniBtn.TextColor3 = Color3.new(1, 1, 1)
miniBtn.Text = "+"
miniBtn.Visible = false
miniBtn.ZIndex = 10
miniBtn.Active = true
miniBtn.Parent = gui

local miniBtnCorner = Instance.new("UICorner")
miniBtnCorner.CornerRadius = UDim.new(0.5, 0)
miniBtnCorner.Parent = miniBtn

local miniLabel = Instance.new("TextLabel")
miniLabel.Size = UDim2.new(1, 0, 0, 15)
miniLabel.Position = UDim2.new(0, 0, 1, 2)
miniLabel.BackgroundTransparency = 1
miniLabel.Text = "AIM"
miniLabel.Font = Enum.Font.GothamBold
miniLabel.TextSize = 10
miniLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
miniLabel.Parent = miniBtn

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 160, 0, 310)
mainFrame.Position = UDim2.new(0.85, -160, 0.3, 0)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
mainFrame.BorderSizePixel = 0
mainFrame.Active = false
mainFrame.Parent = gui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

local dragHandle = Instance.new("Frame")
dragHandle.Size = UDim2.new(1, 0, 0, 35)
dragHandle.BackgroundTransparency = 1
dragHandle.Active = true
dragHandle.Parent = mainFrame

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, -45, 1, 0)
titleLabel.Position = UDim2.new(0, 10, 0, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "AIM ASSIST"
titleLabel.Font = Enum.Font.GothamBold
titleLabel.TextSize = 16
titleLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
titleLabel.TextXAlignment = Enum.TextXAlignment.Left
titleLabel.Parent = dragHandle

local minimizeBtn = Instance.new("TextButton")
minimizeBtn.Size = UDim2.new(0, 20, 0, 20)
minimizeBtn.Position = UDim2.new(1, -25, 0, 7)
minimizeBtn.Text = "-"
minimizeBtn.BackgroundColor3 = Color3.fromRGB(255, 200, 100)
minimizeBtn.TextColor3 = Color3.new(1, 1, 1)
minimizeBtn.Font = Enum.Font.GothamBold
minimizeBtn.TextSize = 20
minimizeBtn.ZIndex = 10
minimizeBtn.Parent = dragHandle

local minimizeCorner = Instance.new("UICorner")
minimizeCorner.CornerRadius = UDim.new(0.5, 0)
minimizeCorner.Parent = minimizeBtn

local statusDot = Instance.new("Frame")
statusDot.Size = UDim2.new(0, 10, 0, 10)
statusDot.Position = UDim2.new(1, -15, 0, 12)
statusDot.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
statusDot.BorderSizePixel = 0
statusDot.Parent = dragHandle

local dotCorner = Instance.new("UICorner")
dotCorner.CornerRadius = UDim.new(0.5, 0)
dotCorner.Parent = statusDot

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(1, -20, 0, 35)
toggleBtn.Position = UDim2.new(0, 10, 0, 45)
toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
toggleBtn.Text = "DISABLED"
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 14
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Parent = mainFrame

local toggleCorner = Instance.new("UICorner")
toggleCorner.CornerRadius = UDim.new(0, 8)
toggleCorner.Parent = toggleBtn

local smoothLabel = Instance.new("TextLabel")
smoothLabel.Size = UDim2.new(1, -20, 0, 20)
smoothLabel.Position = UDim2.new(0, 10, 0, 90)
smoothLabel.BackgroundTransparency = 1
smoothLabel.Text = "Smoothness: 0.25"
smoothLabel.Font = Enum.Font.Gotham
smoothLabel.TextSize = 12
smoothLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
smoothLabel.TextXAlignment = Enum.TextXAlignment.Left
smoothLabel.Parent = mainFrame

local sliderFrame = Instance.new("Frame")
sliderFrame.Size = UDim2.new(1, -20, 0, 8)
sliderFrame.Position = UDim2.new(0, 10, 0, 115)
sliderFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
sliderFrame.BorderSizePixel = 0
sliderFrame.Parent = mainFrame

local sliderCorner = Instance.new("UICorner")
sliderCorner.CornerRadius = UDim.new(0.5, 0)
sliderCorner.Parent = sliderFrame

local sliderFill = Instance.new("Frame")
sliderFill.Size = UDim2.new(0.25, 0, 1, 0)
sliderFill.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
sliderFill.BorderSizePixel = 0
sliderFill.Parent = sliderFrame

local fillCorner = Instance.new("UICorner")
fillCorner.CornerRadius = UDim.new(0.5, 0)
fillCorner.Parent = sliderFill

local sliderKnob = Instance.new("TextButton")
sliderKnob.Size = UDim2.new(0, 16, 0, 16)
sliderKnob.Position = UDim2.new(0.25, -8, 0.5, -8)
sliderKnob.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
sliderKnob.Text = ""
sliderKnob.Parent = sliderFrame

local knobCorner = Instance.new("UICorner")
knobCorner.CornerRadius = UDim.new(0.5, 0)
knobCorner.Parent = sliderKnob

-- Settings
local smoothness = 0.25
local aimPart = "Head"
local wallCheckEnabled = true
local teamCheckEnabled = true
local maxDistance = 300

-- CRITICAL FIX: Check if on same team
local function isTeammate(targetPlayer)
    if not teamCheckEnabled then return false end
    if not Teams then return false end
    if not player.Team or not targetPlayer.Team then return false end
    return player.Team == targetPlayer.Team
end

-- CRITICAL FIX: Wall detection
local function hasLineOfSight(targetPart)
    if not wallCheckEnabled then return true end
    if not camera or not targetPart then return false end
    
    local origin = camera.CFrame.Position
    local direction = (targetPart.Position - origin)
    local distance = direction.Magnitude
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {character}
    if targetPart.Parent then
        table.insert(raycastParams.FilterDescendantsInstances, targetPart.Parent)
    end
    raycastParams.FilterType = Enum.RaycastFilterType.Exclude
    raycastParams.IgnoreWater = true
    
    local result = workspace:Raycast(origin, direction.Unit * (distance - 0.5), raycastParams)
    return result == nil
end

-- CRITICAL FIX: Get valid target
local function getClosestTarget()
    if not camera or not hrp then return nil end
    
    local closestTarget = nil
    local closestDistance = math.huge
    local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
    
    for _, targetPlayer in ipairs(Players:GetPlayers()) do
        if targetPlayer ~= player and targetPlayer.Character then
            if isTeammate(targetPlayer) then continue end
            
            local targetChar = targetPlayer.Character
            local targetPart = targetChar:FindFirstChild(aimPart) or targetChar:FindFirstChild("Head")
            local targetHum = targetChar:FindFirstChildWhichIsA("Humanoid")
            
            if targetPart and targetHum and targetHum.Health > 0 then
                local distance = (targetPart.Position - hrp.Position).Magnitude
                
                if distance <= maxDistance then
                    if hasLineOfSight(targetPart) then
                        local screenPos, onScreen = camera:WorldToViewportPoint(targetPart.Position)
                        
                        if onScreen then
                            local screenDistance = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
                            
                            if screenDistance < FOV_RADIUS and screenDistance < closestDistance then
                                closestDistance = screenDistance
                                closestTarget = targetPart
                            end
                        end
                    end
                end
            end
        end
    end
    
    return closestTarget
end

-- Toggle button
toggleBtn.Activated:Connect(function()
    aimAssistEnabled = not aimAssistEnabled
    
    if aimAssistEnabled then
        toggleBtn.Text = "ENABLED"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(80, 255, 100)
        statusDot.BackgroundColor3 = Color3.fromRGB(80, 255, 100)
        print("âœ… Aim Assist ENABLED")
    else
        toggleBtn.Text = "DISABLED"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
        statusDot.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
        currentTarget = nil
        print("âŒ Aim Assist DISABLED")
    end
end)

-- Smoothness slider
local sliderDragging = false

sliderKnob.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        sliderDragging = true
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                sliderDragging = false
            end
        end)
    end
end)

sliderKnob.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        if sliderDragging then
            local mousePos = input.Position
            local sliderPos = sliderFrame.AbsolutePosition
            local sliderSize = sliderFrame.AbsoluteSize
            
            local relativeX = math.clamp((mousePos.X - sliderPos.X) / sliderSize.X, 0, 1)
            smoothness = math.clamp(relativeX, 0.05, 0.95)
            
            sliderFill.Size = UDim2.new(smoothness, 0, 1, 0)
            sliderKnob.Position = UDim2.new(smoothness, -8, 0.5, -8)
            smoothLabel.Text = "Smoothness: " .. string.format("%.2f", smoothness)
        end
    end
end)

-- CRITICAL FIX: Main aim assist loop
RunService.RenderStepped:Connect(function()
    if not aimAssistEnabled then 
        currentTarget = nil
        return 
    end
    
    if not camera or not hrp then return end
    
    -- Get target
    currentTarget = getClosestTarget()
    
    if currentTarget and currentTarget.Parent then
        local targetPos = currentTarget.Position
        local currentCFrame = camera.CFrame
        
        -- Create desired look direction
        local desiredCFrame = CFrame.new(currentCFrame.Position, targetPos)
        
        -- Smooth interpolation
        camera.CFrame = currentCFrame:Lerp(desiredCFrame, smoothness)
    end
end)

print("âœ… Multi-Universal Aim Assist [FIXED] loaded!")
print("ðŸ’¡ Press toggle button to enable/disable")
print("âš™ï¸ Adjust smoothness with slider")
