-- Heavens FPS Optimizer v2
-- Safe for all games - No kick risk
-- Optimized for Mobile (Arceus X Compatible)

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer

-- Safety: Don't run on server-side
if not player then return end

-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create Window (Following Rayfield Docs)
local Window = Rayfield:CreateWindow({
   Name = "âš¡ Heavens FPS Optimizer",
   LoadingTitle = "Heavens FPS Optimizer",
   LoadingSubtitle = "by Heaven",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil,
      FileName = "HeavensFPS"
   },
   Discord = {
      Enabled = false,
      Invite = "",
      RememberJoins = false
   },
   KeySystem = false
})

-- Settings Storage
local settings = {
	autoCleanDebris = false,
	autoMemoryClean = false,
	particlesRemoved = false,
	lowGraphicsEnabled = false
}

-- Utility Functions
local function safeDestroy(obj)
	pcall(function()
		if obj and obj.Parent then
			obj:Destroy()
		end
	end)
end

local function isPlayerPart(obj)
	-- Check if part belongs to any player
	for _, p in pairs(Players:GetPlayers()) do
		if p.Character and obj:IsDescendantOf(p.Character) then
			return true
		end
	end
	return false
end

-- ============================================
-- HOME TAB
-- ============================================
local HomeTab = Window:CreateTab("ðŸ  Home", 4483362458)

local Section1 = HomeTab:CreateSection("Quick Actions")

-- Server Refresh Button
HomeTab:CreateButton({
   Name = "ðŸ”„ Server Refresh (Lag Fix)",
   Callback = function()
		Rayfield:Notify({
			Title = "Server Refresh",
			Content = "Refreshing your game...",
			Duration = 2,
			Image = 4483362458,
			Actions = {
				Ignore = {
					Name = "Okay!",
					Callback = function() end
				}
			}
		})
		
		task.spawn(function()
			-- SAFE METHOD: No character breaking, just cleanup
			
			-- 1. Clear invisible/destroyed parts
			local cleaned = 0
			for _, obj in pairs(Workspace:GetDescendants()) do
				if obj:IsA("BasePart") and not isPlayerPart(obj) then
					if obj.Transparency >= 0.99 or obj.Size.Magnitude < 0.1 then
						safeDestroy(obj)
						cleaned = cleaned + 1
					end
				end
			end
			
			-- 2. Remove disconnected instances
			for _, obj in pairs(Workspace:GetChildren()) do
				if obj:IsA("Model") and #obj:GetChildren() == 0 then
					safeDestroy(obj)
					cleaned = cleaned + 1
				end
			end
			
			-- 3. Force garbage collection (safe)
			for i = 1, 3 do
				task.wait(0.1)
				collectgarbage("collect")
			end
			
			task.wait(0.5)
			
			Rayfield:Notify({
				Title = "âœ… Refresh Complete!",
				Content = "Cleaned " .. cleaned .. " objects. FPS should improve!",
				Duration = 3,
				Image = 4483362458
			})
		end)
   end,
})

-- Clean All Debris
HomeTab:CreateButton({
   Name = "ðŸ§¹ Clean Debris Now",
   Callback = function()
		task.spawn(function()
			local cleaned = 0
			
			for _, obj in pairs(Workspace:GetDescendants()) do
				if isPlayerPart(obj) then continue end
				
				local shouldClean = false
				
				-- Safe debris detection
				if obj:IsA("BasePart") then
					local name = obj.Name:lower()
					
					-- Common debris names
					if name:find("debris") or name:find("rubble") or name:find("destruction") or
					   name:find("broken") or name:find("shatter") or name:find("fragment") or
					   name:find("rock") or name:find("stone") or name:find("crater") then
						shouldClean = true
					end
					
					-- Small unanchored parts (likely debris)
					if not obj.Anchored and obj.Size.Magnitude < 8 and obj.Transparency < 1 then
						-- Check if it's been sitting still (real debris doesn't move)
						if obj.AssemblyLinearVelocity.Magnitude < 0.5 then
							shouldClean = true
						end
					end
				end
				
				-- Clean particles/effects
				if obj:IsA("ParticleEmitter") or obj:IsA("Trail") or obj:IsA("Smoke") or obj:IsA("Fire") then
					if not isPlayerPart(obj) then
						shouldClean = true
					end
				end
				
				if shouldClean then
					safeDestroy(obj)
					cleaned = cleaned + 1
				end
			end
			
			collectgarbage("collect")
			
			Rayfield:Notify({
				Title = "âœ… Cleanup Complete",
				Content = "Removed " .. cleaned .. " debris objects!",
				Duration = 3,
				Image = 4483362458
			})
		end)
   end,
})

local Section2 = HomeTab:CreateSection("Auto Features")

-- Auto Clean Debris Toggle
HomeTab:CreateToggle({
   Name = "ðŸ” Auto-Clean Debris",
   CurrentValue = false,
   Flag = "AutoClean",
   Callback = function(Value)
		settings.autoCleanDebris = Value
		
		Rayfield:Notify({
			Title = Value and "Auto-Clean ON" or "Auto-Clean OFF",
			Content = Value and "Debris cleaned every 15 seconds" or "Auto-clean disabled",
			Duration = 2,
			Image = 4483362458
		})
   end,
})

-- Auto Memory Cleanup
HomeTab:CreateToggle({
   Name = "ðŸ§  Auto Memory Cleanup",
   CurrentValue = false,
   Flag = "AutoMemory",
   Callback = function(Value)
		settings.autoMemoryClean = Value
		
		Rayfield:Notify({
			Title = Value and "Auto Memory ON" or "Auto Memory OFF",
			Content = Value and "Memory cleaned every 30 seconds" or "Auto memory disabled",
			Duration = 2,
			Image = 4483362458
		})
   end,
})

-- ============================================
-- GRAPHICS TAB
-- ============================================
local GraphicsTab = Window:CreateTab("ðŸŽ¨ Graphics", 4483362458)

local Section3 = GraphicsTab:CreateSection("Visual Quality")

-- Low Graphics Mode
GraphicsTab:CreateToggle({
   Name = "ðŸ“‰ Low Graphics Mode",
   CurrentValue = false,
   Flag = "LowGraphics",
   Callback = function(Value)
		settings.lowGraphicsEnabled = Value
		
		if Value then
			-- SAFE: Only modify Lighting effects
			pcall(function()
				for _, effect in pairs(Lighting:GetChildren()) do
					if effect:IsA("PostEffect") then
						effect.Enabled = false
					end
				end
				
				Lighting.GlobalShadows = false
				Lighting.Brightness = 2
			end)
			
			Rayfield:Notify({
				Title = "Low Graphics Enabled",
				Content = "Shadows and effects disabled",
				Duration = 2,
				Image = 4483362458
			})
		else
			pcall(function()
				for _, effect in pairs(Lighting:GetChildren()) do
					if effect:IsA("PostEffect") then
						effect.Enabled = true
					end
				end
				
				Lighting.GlobalShadows = true
				Lighting.Brightness = 1
			end)
		end
   end,
})

-- Remove Particles
GraphicsTab:CreateToggle({
   Name = "âœ¨ Remove Particles/Effects",
   CurrentValue = false,
   Flag = "RemoveParticles",
   Callback = function(Value)
		settings.particlesRemoved = Value
		
		if Value then
			for _, obj in pairs(Workspace:GetDescendants()) do
				if obj:IsA("ParticleEmitter") or obj:IsA("Trail") or obj:IsA("Beam") then
					if not isPlayerPart(obj) then
						obj.Enabled = false
					end
				end
			end
			
			Rayfield:Notify({
				Title = "Particles Removed",
				Content = "All effects disabled for FPS boost",
				Duration = 2,
				Image = 4483362458
			})
		else
			for _, obj in pairs(Workspace:GetDescendants()) do
				if obj:IsA("ParticleEmitter") or obj:IsA("Trail") or obj:IsA("Beam") then
					obj.Enabled = true
				end
			end
		end
   end,
})

-- Texture Quality Slider
GraphicsTab:CreateSlider({
   Name = "ðŸ–¼ï¸ Texture Quality",
   Range = {1, 10},
   Increment = 1,
   Suffix = "/10",
   CurrentValue = 10,
   Flag = "TextureQuality",
   Callback = function(Value)
		pcall(function()
			settings().Rendering.QualityLevel = Enum.QualityLevel["Level0" .. Value]
		end)
   end,
})

local Section4 = GraphicsTab:CreateSection("Advanced Rendering")

-- Optimize Terrain
GraphicsTab:CreateButton({
   Name = "ðŸ”ï¸ Optimize Terrain",
   Callback = function()
		pcall(function()
			local terrain = Workspace:FindFirstChildOfClass("Terrain")
			if terrain then
				terrain.WaterWaveSize = 0
				terrain.WaterWaveSpeed = 0
				terrain.WaterReflectance = 0
				terrain.WaterTransparency = 0.9
				terrain.Decoration = false
			end
		end)
		
		Rayfield:Notify({
			Title = "âœ… Terrain Optimized",
			Content = "Water effects reduced",
			Duration = 2,
			Image = 4483362458
		})
   end,
})

-- Reduce Shadows
GraphicsTab:CreateButton({
   Name = "ðŸŒ‘ Remove All Shadows",
   Callback = function()
		local count = 0
		for _, obj in pairs(Workspace:GetDescendants()) do
			if obj:IsA("BasePart") and obj.CastShadow then
				obj.CastShadow = false
				count = count + 1
			end
		end
		
		Rayfield:Notify({
			Title = "âœ… Shadows Removed",
			Content = "Disabled shadows on " .. count .. " parts",
			Duration = 2,
			Image = 4483362458
		})
   end,
})

-- ============================================
-- PERFORMANCE TAB
-- ============================================
local PerfTab = Window:CreateTab("âš¡ Performance", 4483362458)

local Section5 = PerfTab:CreateSection("Optimization Tools")

-- Optimize Parts
PerfTab:CreateButton({
   Name = "ðŸ”§ Optimize All Parts",
   Callback = function()
		task.spawn(function()
			local optimized = 0
			
			for _, obj in pairs(Workspace:GetDescendants()) do
				if isPlayerPart(obj) then continue end
				
				if obj:IsA("BasePart") then
					-- Disable shadows on small parts
					if obj.Size.Magnitude < 10 and obj.CastShadow then
						obj.CastShadow = false
						optimized = optimized + 1
					end
					
					-- Remove collision on transparent parts
					if obj.Transparency > 0.8 and obj.CanCollide then
						obj.CanCollide = false
						optimized = optimized + 1
					end
				end
				
				-- Optimize meshes
				if obj:IsA("MeshPart") then
					obj.RenderFidelity = Enum.RenderFidelity.Performance
					optimized = optimized + 1
				end
				
				-- Limit decals/textures
				if obj:IsA("Decal") or obj:IsA("Texture") then
					if obj.Transparency > 0.5 then
						obj.Transparency = 1
						optimized = optimized + 1
					end
				end
			end
			
			Rayfield:Notify({
				Title = "âœ… Parts Optimized",
				Content = "Optimized " .. optimized .. " objects!",
				Duration = 3,
				Image = 4483362458
			})
		end)
   end,
})

-- Force Memory Cleanup
PerfTab:CreateButton({
   Name = "ðŸ’¾ Force Memory Cleanup",
   Callback = function()
		task.spawn(function()
			-- Aggressive but safe garbage collection
			for i = 1, 5 do
				collectgarbage("collect")
				task.wait(0.15)
			end
			
			-- Clear Lua memory
			collectgarbage("stop")
			task.wait(0.1)
			collectgarbage("restart")
			
			Rayfield:Notify({
				Title = "âœ… Memory Cleaned",
				Content = "Forced garbage collection complete!",
				Duration = 2,
				Image = 4483362458
			})
		end)
   end,
})

-- Remove Unnecessary Sounds
PerfTab:CreateButton({
   Name = "ðŸ”‡ Mute Background Sounds",
   Callback = function()
		local muted = 0
		for _, obj in pairs(Workspace:GetDescendants()) do
			if obj:IsA("Sound") and not isPlayerPart(obj) then
				if obj.Playing and obj.Volume > 0 then
					obj.Volume = 0
					muted = muted + 1
				end
			end
		end
		
		Rayfield:Notify({
			Title = "âœ… Sounds Muted",
			Content = "Muted " .. muted .. " background sounds",
			Duration = 2,
			Image = 4483362458
		})
   end,
})

local Section6 = PerfTab:CreateSection("FPS Monitor")

-- FPS Display
local FPSLabel = PerfTab:CreateLabel("FPS: Calculating...")
local PingLabel = PerfTab:CreateLabel("Ping: Calculating...")

-- ============================================
-- SETTINGS TAB
-- ============================================
local SettingsTab = Window:CreateTab("âš™ï¸ Settings", 4483362458)

SettingsTab:CreateSection("Information")

SettingsTab:CreateParagraph({Title = "About", Content = "Heavens FPS Optimizer v2 - Optimized for mobile devices and safe for all games. No kick risk!"})

SettingsTab:CreateParagraph({Title = "Features", Content = "â€¢ Server Refresh (no respawn)\nâ€¢ Smart debris cleaning\nâ€¢ Graphics optimization\nâ€¢ Memory management\nâ€¢ Real-time FPS counter"})

SettingsTab:CreateButton({
   Name = "ðŸ“‹ Copy Discord Link",
   Callback = function()
		setclipboard("discord.gg/yourlink")
		Rayfield:Notify({
			Title = "Copied!",
			Content = "Discord link copied to clipboard",
			Duration = 2,
			Image = 4483362458
		})
   end,
})

-- ============================================
-- BACKGROUND LOOPS
-- ============================================

-- Auto-clean debris loop
task.spawn(function()
	while task.wait(15) do
		if settings.autoCleanDebris then
			local cleaned = 0
			for _, obj in pairs(Workspace:GetDescendants()) do
				if not isPlayerPart(obj) then
					if obj:IsA("BasePart") then
						local name = obj.Name:lower()
						if name:find("debris") or name:find("rubble") or name:find("destruction") then
							safeDestroy(obj)
							cleaned = cleaned + 1
						end
					end
				end
			end
			
			if cleaned > 5 then
				print("[Auto-Clean] Removed " .. cleaned .. " debris")
			end
		end
	end
end)

-- Auto memory cleanup loop
task.spawn(function()
	while task.wait(30) do
		if settings.autoMemoryClean then
			collectgarbage("collect")
			print("[Auto-Memory] Garbage collection complete")
		end
	end
end)

-- FPS Counter
task.spawn(function()
	local lastTime = tick()
	local frameCount = 0
	local fps = 0
	
	RunService.RenderStepped:Connect(function()
		frameCount = frameCount + 1
		local currentTime = tick()
		
		if currentTime - lastTime >= 1 then
			fps = frameCount
			frameCount = 0
			lastTime = currentTime
		end
	end)
	
	while task.wait(0.5) do
		FPSLabel:Set("FPS: " .. fps)
		
		-- Ping calculation
		local success, ping = pcall(function()
			return game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValue()
		end)
		
		if success then
			PingLabel:Set("Ping: " .. math.floor(ping) .. " ms")
		end
	end
end)

-- Keep particles disabled if setting enabled
task.spawn(function()
	while task.wait(2) do
		if settings.particlesRemoved then
			for _, obj in pairs(Workspace:GetDescendants()) do
				if (obj:IsA("ParticleEmitter") or obj:IsA("Trail") or obj:IsA("Beam")) and not isPlayerPart(obj) then
					if obj.Enabled then
						obj.Enabled = false
					end
				end
			end
		end
	end
end)

-- Initialization
Rayfield:Notify({
   Title = "âš¡ Heavens FPS Optimizer",
   Content = "Loaded successfully! Safe for all games.",
   Duration = 5,
   Image = 4483362458,
   Actions = {
      Ignore = {
         Name = "Let's Go!",
         Callback = function()
            print("User acknowledged load")
         end
      },
   },
})

print("=================================")
print("âš¡ Heavens FPS Optimizer v2 Loaded")
print("âœ… Safe Mode - No kick risk")
print("âœ… Mobile Optimized - Arceus X Compatible")
print("=================================")
